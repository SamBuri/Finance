/*
 Sam Buriima
generated by Saburi Tools
 */
package com.saburi.finance.dbaccess;

import com.saburi.common.dbaccess.DBAccess;
import com.saburi.common.dbaccess.IDGeneratorDA;
import com.saburi.finance.entities.BankLedger;
import javafx.beans.property.*;
import java.util.ArrayList;
import com.saburi.common.entities.AppRevisionEntity;
import com.saburi.finance.entities.BankAccount;
import com.saburi.common.entities.Company;
import com.saburi.finance.entities.FinancialPeriod;
import com.saburi.finance.entities.JournalEntry;
import java.util.List;
import com.saburi.common.utils.SearchColumn;
import com.saburi.common.utils.SearchColumn.SearchDataTypes;
import org.hibernate.envers.RevisionType;
import com.saburi.finance.entities.JournalEntryDetail;
import java.time.LocalDate;
import java.util.stream.Stream;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Join;
import javax.persistence.criteria.Root;
import static com.saburi.common.utils.Utilities.formatDate;
import com.saburi.finance.utils.FinanceEnums.DocumentTypes;
import static com.saburi.common.utils.Utilities.formatNumber;

public class BankLedgerDA extends DBAccess {

    private BankLedger bankLedger = new BankLedger();
    private final SimpleIntegerProperty ledgerID = new SimpleIntegerProperty(this, "ledgerID");
    private final SimpleStringProperty journalEntryDetailDisplay = new SimpleStringProperty(this, "journalEntryDetailDisplay");
    private final SimpleObjectProperty journalEntryDetailID = new SimpleObjectProperty(this, "journalEntryDetailID");
    private JournalEntryDetail journalEntryDetail;
    private final SimpleStringProperty bankAccountID = new SimpleStringProperty(this, "bankAccountID");
    private final SimpleStringProperty bankAccountName = new SimpleStringProperty(this, "bankAccountName");
    private final SimpleObjectProperty postingDate = new SimpleObjectProperty(this, "postingDate");
    private final SimpleStringProperty postingDateDisplay = new SimpleStringProperty(this, "postingDateDisplay");
    private final SimpleObjectProperty documentType = new SimpleObjectProperty(this, "documentType");
    private final SimpleStringProperty description = new SimpleStringProperty(this, "description");
    private final SimpleStringProperty documentNo = new SimpleStringProperty(this, "documentNo");
    private final SimpleStringProperty referenceNo = new SimpleStringProperty(this, "referenceNo");
    private final SimpleDoubleProperty amount = new SimpleDoubleProperty(this, "amount");
    private final SimpleStringProperty amountDisplay = new SimpleStringProperty(this, "amountDisplay");
    private final SimpleDoubleProperty debit = new SimpleDoubleProperty(this, "debit");
    private final SimpleStringProperty debitDisplay = new SimpleStringProperty(this, "debitDisplay");
    private final SimpleDoubleProperty credit = new SimpleDoubleProperty(this, "credit");
    private final SimpleStringProperty creditDisplay = new SimpleStringProperty(this, "creditDisplay");
    private final SimpleDoubleProperty balance = new SimpleDoubleProperty(this, "balance");
    private final SimpleStringProperty balanceDisplay = new SimpleStringProperty(this, "balanceDisplay");

    public BankLedgerDA() {
        createSearchColumns();
    }

    public BankLedgerDA(String persistenceUnit) {
        super(persistenceUnit);
    }

    public BankLedgerDA(BankLedger bankLedger) {
        this.bankLedger = bankLedger;
        initialseProprties();
        createSearchColumns();
    }

    public BankLedgerDA(String persistenceUnit, BankLedger bankLedger) {
        super(persistenceUnit);
        this.bankLedger = bankLedger;
        initialseProprties();
        createSearchColumns();
    }

    public BankLedgerDA(JournalEntryDetail journalEntryDetail, String bankAccountID, String bankAccountName, LocalDate postingDate, DocumentTypes documentType, String description, String documentNo, String referenceNo, double amount, double debit, double credit, double balance) {
        this.bankLedger = new BankLedger(journalEntryDetail, bankAccountID, bankAccountName, postingDate, documentType, description, documentNo, referenceNo, amount, balance);
        initialseProprties();
        createSearchColumns();
    }

    public BankLedgerDA(String persistenceUnit, JournalEntryDetail journalEntryDetail, String bankAccountID, String bankAccountName, LocalDate postingDate, DocumentTypes documentType, String description, String documentNo, String referenceNo, double amount, double debit, double credit, double balance) {
        super(persistenceUnit);
        this.bankLedger = new BankLedger(journalEntryDetail, bankAccountID, bankAccountName, postingDate, documentType, description, documentNo, referenceNo, amount, balance);
        initialseProprties();
        createSearchColumns();
    }

    public int getLedgerID() {
        return ledgerID.get();
    }

    public void setLedgerID(int ledgerID) {
        bankLedger.setLedgerID(ledgerID);
        this.ledgerID.set(ledgerID);
    }

    public JournalEntryDetail getJournalEntryDetail() {
        return journalEntryDetail;
    }

    public Object getJournalEntryDetailID() {
        return journalEntryDetailID.get();
    }

    public String getJournalEntryDetailDisplay() {
        return journalEntryDetailDisplay.get();
    }

    public JournalEntryDetailDA getJournalEntryDetailDA() {
        return this.journalEntryDetail != null ? new JournalEntryDetailDA(this.journalEntryDetail) : null;
    }

    public void setJournalEntryDetail(JournalEntryDetail journalEntryDetail) {
        bankLedger.setJournalEntryDetail(journalEntryDetail);
        this.journalEntryDetail = journalEntryDetail;
        this.journalEntryDetailID.set(journalEntryDetail.getId());
        this.journalEntryDetailDisplay.set(journalEntryDetail.getDisplayKey());
    }

    public String getBankAccountID() {
        return bankAccountID.get();
    }

    public void setBankAccountID(String bankAccountID) {
        bankLedger.setBankAccountID(bankAccountID);
        this.bankAccountID.set(bankAccountID);
    }

    public String getBankAccountName() {
        return bankAccountName.get();
    }

    public void setBankAccountName(String bankAccountName) {
        bankLedger.setBankAccountName(bankAccountName);
        this.bankAccountName.set(bankAccountName);
    }

    public Object getPostingDate() {
        return postingDate.get();
    }

    public String getPostingDateDisplay() {
        return postingDateDisplay.get();
    }

    public void setPostingDate(LocalDate postingDate) {
        bankLedger.setPostingDate(postingDate);
        this.postingDate.set(postingDate);
    }

    public Object getDocumentType() {
        return documentType.get();
    }

    public void setDocumentType(DocumentTypes documentType) {
        bankLedger.setDocumentType(documentType);
        this.documentType.set(documentType);
    }

    public String getDescription() {
        return description.get();
    }

    public void setDescription(String description) {
        bankLedger.setDescription(description);
        this.description.set(description);
    }

    public String getDocumentNo() {
        return documentNo.get();
    }

    public void setDocumentNo(String documentNo) {
        bankLedger.setDocumentNo(documentNo);
        this.documentNo.set(documentNo);
    }

    public String getReferenceNo() {
        return referenceNo.get();
    }

    public void setReferenceNo(String referenceNo) {
        bankLedger.setReferenceNo(referenceNo);
        this.referenceNo.set(referenceNo);
    }

    public double getAmount() {
        return amount.get();
    }

    public String getAmountDisplay() {
        return amountDisplay.get();
    }

    public void setAmount(double amount) {
        bankLedger.setAmount(amount);
        this.amount.set(amount);
        this.amountDisplay.set(formatNumber(amount));
    }

    public double getDebit() {
        return debit.get();
    }

    public String getDebitDisplay() {
        return debitDisplay.get();
    }

    public void setDebit(double debit) {
        bankLedger.setDebit(debit);
        this.debit.set(debit);
        this.debitDisplay.set(formatNumber(debit));
    }

    public double getCredit() {
        return credit.get();
    }

    public String getCreditDisplay() {
        return creditDisplay.get();
    }

    public void setCredit(double credit) {
        bankLedger.setCredit(credit);
        this.credit.set(credit);
        this.creditDisplay.set(formatNumber(credit));
    }

    public double getBalance() {
        return balance.get();
    }

    public String getBalanceDisplay() {
        return balanceDisplay.get();
    }

    public void setBalance(double balance) {
        bankLedger.setBalance(balance);
        this.balance.set(balance);
        this.balanceDisplay.set(formatNumber(balance));
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) {
            return true;
        }
        if (!(o instanceof BankLedgerDA)) {
            return false;
        }

        BankLedgerDA bankLedgerDA = (BankLedgerDA) o;

        if (bankLedgerDA.getDBEntity() == null || this.getDBEntity() == null) {
            return false;
        }
        return this.getId().equals(bankLedgerDA.getId());
    }

    @Override
    public int hashCode() {
        return bankLedger.getId().hashCode();
    }

    private void initialseProprties() {
        this.dBEntity = bankLedger;
        this.ledgerID.set(bankLedger.getLedgerID());
        this.journalEntryDetail = bankLedger.getJournalEntryDetail();
        if (this.journalEntryDetail != null) {
            this.journalEntryDetailID.set(journalEntryDetail.getId());
            this.journalEntryDetailDisplay.set(journalEntryDetail.getDisplayKey());
        }
        this.bankAccountID.set(bankLedger.getBankAccountID());
        this.bankAccountName.set(bankLedger.getBankAccountName());
        this.postingDate.set(bankLedger.getPostingDate());
        this.postingDateDisplay.set(formatDate(bankLedger.getPostingDate()));
        this.documentType.set(bankLedger.getDocumentType());
        this.description.set(bankLedger.getDescription());
        this.documentNo.set(bankLedger.getDocumentNo());
        this.referenceNo.set(bankLedger.getReferenceNo());
        this.amount.set(bankLedger.getAmount());
        this.amountDisplay.set(formatNumber(bankLedger.getAmount()));
        this.debit.set(bankLedger.getDebit());
        this.debitDisplay.set(formatNumber(bankLedger.getDebit()));
        this.credit.set(bankLedger.getCredit());
        this.creditDisplay.set(formatNumber(bankLedger.getCredit()));
        this.balance.set(bankLedger.getBalance());
        this.balanceDisplay.set(formatNumber(bankLedger.getBalance()));
        initCommonProprties();
    }

    private void createSearchColumns() {
        this.searchColumns.add(new SearchColumn("journalEntryDetailID", "Journal Entry Detail ID", this.journalEntryDetailID.get(), SearchDataTypes.STRING, SearchColumn.SearchType.Equal, false));
        this.searchColumns.add(new SearchColumn("journalEntryDetailDisplay", "Journal Entry Detail", this.journalEntryDetailDisplay.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("bankAccountID", "Bank Account ID", this.bankAccountID.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("bankAccountName", "Bank Account Name", this.bankAccountName.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("postingDate", "Posting Date", this.postingDate.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("documentType", "Document Type", this.documentType.get(), SearchDataTypes.STRING, SearchColumn.SearchType.Equal));
        this.searchColumns.add(new SearchColumn("description", "Description", this.description.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("documentNo", "Document No", this.documentNo.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("referenceNo", "Reference No", this.referenceNo.get(), SearchDataTypes.STRING));
        this.searchColumns.add(new SearchColumn("amount", "Amount", this.amount.get(), SearchDataTypes.NUMBER));
        this.searchColumns.add(new SearchColumn("debit", "Debit", this.debit.get(), SearchDataTypes.NUMBER));
        this.searchColumns.add(new SearchColumn("credit", "Credit", this.credit.get(), SearchDataTypes.NUMBER));
        this.searchColumns.add(new SearchColumn("balance", "Balance", this.balance.get(), SearchDataTypes.NUMBER));
        this.searchColumns.addAll(this.getDefaultSearchColumns());
    }

    @Override
    public List<SearchColumn> getSearchColumns() {
        return this.searchColumns;
    }

    @Override
    public Object getId() {
        return this.bankLedger.getId();
    }

    @Override
    public String getDisplayKey() {
        return this.bankLedger.getDisplayKey();
    }

    public static List<BankLedgerDA> getBankLedgerDAs(List<BankLedger> bankLedgers) {
        List<BankLedgerDA> list = new ArrayList<>();
        bankLedgers.forEach((bankLedger) -> {
            list.add(new BankLedgerDA(bankLedger));
        });
        return list;
    }

    public static List<BankLedger> getBankLedgerList(List<BankLedgerDA> bankLedgerDAs) {
        List<BankLedger> bankLedgers = new ArrayList<>();
        bankLedgerDAs.forEach(a -> bankLedgers.add(a.bankLedger));
        return bankLedgers;
    }

    public boolean save() throws Exception {
        return super.persist(this.bankLedger);

    }

    public boolean update() throws Exception {
        return super.merge(this.bankLedger);

    }

    public boolean delete() {
        return super.remove(this.bankLedger);

    }

    public BankLedger getBankLedger(String ledgerID) {
        return (BankLedger) super.find(BankLedger.class, ledgerID);
    }

    public BankLedger getBankLedger() {
        return this.bankLedger;
    }

    public List<BankLedger> getBankLedgers() {
        return super.find(BankLedger.class);
    }

    @Override
    public List<DBAccess> get() {
        List<DBAccess> list = new ArrayList<>();
        selectQuery(BankLedger.class).forEach(o -> list.add(new BankLedgerDA((BankLedger) o)));
        if (entityManager != null) {
            entityManager.close();
        }
        return list;
    }

    public BankLedgerDA get(String ledgerID) throws Exception {
        BankLedger oBankLedger = getBankLedger(ledgerID);
        if (oBankLedger == null) {
            throw new Exception("No Record with id: " + ledgerID);
        }
        return new BankLedgerDA(oBankLedger);
    }

    public List<BankLedgerDA> get(String columName, Object value) {
        List<BankLedgerDA> list = new ArrayList<>();
        super.selectQuery(BankLedger.class, columName, value).forEach(da -> list.add(new BankLedgerDA((BankLedger) da)));
        if (entityManager != null) {
            entityManager.close();
        }
        return list;
    }

    public List<BankLedgerDA> toDaList(List<BankLedger> bankLedgers) {
        List<BankLedgerDA> bankLedgerDAs = new ArrayList<>();
        bankLedgers.forEach(s -> bankLedgerDAs.add(new BankLedgerDA(s)));
        return bankLedgerDAs;
    }

    public List<DBAccess> toDBAccessList(List<BankLedger> bankLedgers) {
        List<DBAccess> dbAccesses = new ArrayList<>();
        bankLedgers.forEach(s -> dbAccesses.add(new BankLedgerDA(s)));
        return dbAccesses;
    }

    public int getMax(String columnName) {
        return super.getMax(BankLedger.class, columnName);
    }

    public int getMax(String columnName, String comparatorColumn, Object comparatorVaue) {
        return super.getMax(BankLedger.class, columnName, comparatorColumn, comparatorVaue);
    }

    public final int getNextLedgerID() {
        return this.getMax("ledgerID") + 1;
    }

    public String getNextLedgerID(int ledgerID) {
        return new IDGeneratorDA().getToAppendString(BankLedger.class.getSimpleName(), ledgerID);
    }

    public List<BankLedger> getBankLedgers(String columName, Object value) {
        return super.find(BankLedger.class, columName, value);
    }

    @Override
    public List<DBAccess> getRevisions() {
        try {

            List<Object[]> list = getEntityRevisions(BankLedger.class);
            List<DBAccess> dBAccesses = new ArrayList<>();
            list.forEach(e -> {

                BankLedgerDA bankLedgerDA = new BankLedgerDA((BankLedger) e[0]);
                bankLedgerDA.revisionEntity = (AppRevisionEntity) e[1];
                bankLedgerDA.oRevisionType = (RevisionType) e[2];
                bankLedgerDA.initRevProprties();
                bankLedgerDA.searchColumns.addAll(bankLedgerDA.getRevSearchColumns());
                dBAccesses.add(bankLedgerDA);

            });

            return dBAccesses;
        } catch (Exception e) {
            throw e;
        } finally {
            if (entityManager == null) {
                entityManager.close();
            }
        }

    }

    public double getAccountBalance(BankAccount BankAccount, Company company) {

        try {
            entityManager = entityManagerFactory.createEntityManager();
            CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
            CriteriaQuery<Double> criteriaQuery = criteriaBuilder.createQuery(Double.class);
            Root<BankLedger> root = criteriaQuery.from(BankLedger.class);
            Join<BankLedger, JournalEntryDetail> joinJED = root.join("journalEntryDetail");
            Join<JournalEntryDetail, JournalEntry> joinJE = joinJED.join("journalEntry");
            Join<JournalEntry, FinancialPeriod> joinJEFP = joinJE.join("financialPeriod");
            criteriaQuery.select(criteriaBuilder.sum(criteriaBuilder.diff(root.get("debit"), root.get("credit"))));
            criteriaQuery.where(criteriaBuilder.equal(root.get("bankAccountID"), BankAccount.getBankAccountID()),
                    criteriaBuilder.equal(joinJEFP.get("company"), company));
            Stream<Double> result = entityManager.createQuery(criteriaQuery).getResultStream();
            return result.findFirst().orElse(Double.valueOf(0));
        } catch (Exception e) {
            throw e;
        } finally {
            entityManager.close();
        }

    }

    public double getAccountBalance(BankAccount BankAccount) {

        try {
            entityManager = entityManagerFactory.createEntityManager();
            CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
            CriteriaQuery<Double> criteriaQuery = criteriaBuilder.createQuery(Double.class);
            Root<BankLedger> root = criteriaQuery.from(BankLedger.class);
            criteriaQuery.select(criteriaBuilder.sum(criteriaBuilder.diff(root.get("debit"), root.get("credit"))));
            criteriaQuery.where(criteriaBuilder.equal(root.get("bankAccountID"), BankAccount.getBankAccountID()));
            Double result = entityManager.createQuery(criteriaQuery).getSingleResult();
            return result == null ? 0 : result;
        } catch (Exception e) {
            throw e;
        } finally {
            entityManager.close();
        }

    }

}
